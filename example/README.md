# rules_nfpm example

This folder contains an example bazel WORKSPACE and BUILD setup that builds a small `go` binary and packages the binary into `deb` and `rpm` formats. The BUILD files for the packages was generated by Gazelle.

## Usage

```console
$ bazel build packages/...

$ rpm -qil -v ./bazel-bin/packages/helloworld.rpm
error: cannot open Packages database in /var/lib/rpm
error: cannot open Packages database in /var/lib/rpm
Name        : helloworld
Epoch       : 0
Version     : v1.2.3-develop
Release     : 1
Architecture: x86_64
Install Date: (not installed)
Group       : Development/Tools
Size        : 2169992
License     :
Signature   : (none)
Source RPM  : helloworld-v1.2.3-develop-1.src.rpm
Build Date  : Sat Jun 13 15:59:21 2020
Build Host  : 5989.lan
Relocations : (not relocatable)
Packager    :
Vendor      :
URL         :
Summary     : helloworld is a typical "hello, world" program.
Description :
helloworld is a typical "hello, world" program.

helloworld prints "hello, world" and then exits. This particular package was generated at
2020-06-13T19:59:21Z.

-r-xr-xr-x    1 root    root                  2169992 Jun 13 15:46 /usr/bin/helloworld
```

### Gazelle

```console
$ rm packages/BUILD.bazel

$ bazel run //:gazelle
INFO: Analyzed target //:gazelle (1 packages loaded, 3 targets configured).
INFO: Found 1 target...
Target //:gazelle up-to-date:
  bazel-bin/gazelle-runner.bash
  bazel-bin/gazelle
INFO: Elapsed time: 0.775s, Critical Path: 0.06s
INFO: 1 process: 1 internal.
INFO: Build completed successfully, 1 total action
INFO: Build completed successfully, 1 total action

$ cat packages/BUILD.bazel
load("@com_github_ericnorris_rules_nfpm//nfpm:defs.bzl", "nfpm_package")

nfpm_package(
    name = "helloworld.deb",
    config = "helloworld.nfpm.yaml",
    deps = ["//cmd/helloworld"],
)

nfpm_package(
    name = "helloworld.rpm",
    config = "helloworld.nfpm.yaml",
    deps = ["//cmd/helloworld"],
)
```

## Internals

The directory's [.bazelrc](/example/.bazelrc) file configures the [workspace-status.sh](/example/workspace-status.sh) script to run on every `bazel build` invocation. The [workspace status](https://docs.bazel.build/versions/master/user-manual.html#workspace_status) script produces "stable" and "volatile" key-value pairs that are useable later; the values are hardcoded for the purposes of this example, but could be dynamically computed via `git` commands.

[packages/BUILD.bazel](/example/packages/BUILD.bazel) configures two targets, `helloworld.rpm` and `helloworld.deb`. Each depend on the `//cmd/helloworld` target, which is a small `go` binary.

The package targets use [packages/helloworld.yaml](/example/packages/helloworld.yaml) as a template to configure [NFPM](https://github.com/goreleaser/nfpm/). The actual configuration is generated by the `go` [template](https://golang.org/pkg/text/template/) package, where `.` is a [ConfigTemplateData](https://pkg.go.dev/github.com/ericnorris/rules_nfpm/go/internal/cmd/nfpmwrapper?tab=doc#ConfigTemplateData) struct.
